"use strict";var express=require("express"),connection=require("../connection"),router=express.Router(),ejs=require("ejs"),pdf=require("html-pdf"),path=require("path"),fs=require("fs"),uuid=require("uuid"),auth=require("../services/authentication"),_require=require("stream/consumers"),json=_require.json;router.post("/generateReport",auth.authenticateToken,function(e,n){var o=uuid.v1(),r=e.body,a=JSON.parse(r.productDetails);connection.query("insert into bill (name,uuid,email,contactNumber,paymentMethod,total,productDetails,createdBy) values(?,?,?,?,?,?,?,?)",[r.name,o,r.email,r.contactNumber,r.paymentMethod,r.totalAmount,r.productDetails,n.locals.email],function(e,t){if(e)return n.status(500).json(e);ejs.renderFile(path.join(__dirname,"","report.ejs"),{productDetails:a,name:r.name,email:r.email,contactNumber:r.contactNumber,paymentMethod:r.paymentMethod,totalAmount:r.totalAmount},function(e,t){if(e)return n.status(500).json(e);pdf.create(t).toFile("./generate_pdf/"+o+".pdf",function(e,t){return e?(console.log(e),n.status(500).json(e)):n.status(200).json({uuid:o})})})})}),router.post("/getPdf",auth.authenticateToken,function(e,n){var o=e.body,r="./generate_pdf/"+o.uuid+".pdf";if(fs.existsSync(r))n.contentType("application/pdf"),fs.createReadStream(r).pipe(n);else{var t=JSON.parse(o.productDetails);ejs.renderFile(path.join(__dirname,"","report.ejs"),{productDetails:t,name:o.name,email:o.email,contactNumber:o.contactNumber,paymentMethod:o.paymentMethod,totalAmount:o.totalAmount},function(e,t){if(e)return n.status(500).json(e);pdf.create(t).toFile("./generate_pdf/"+o.uuid+".pdf",function(e,t){if(e)return console.log(e),n.status(500).json(e);n.contentType("application/pdf"),fs.createReadStream(r).pipe(n)})})}}),router.get("/getBills",auth.authenticateToken,function(e,n,t){connection.query("select * from bill order by id DESC",function(e,t){return e?n.status(500).json(e):n.status(200).json(t)})}),router.delete("/delete/:id",auth.authenticateToken,function(e,n,t){var o=e.params.id;connection.query("delete from bill where id=?",[o],function(e,t){return e?n.status(500).json(e):0==t.affectedRows?n.status(404).json({message:"Bill id does not found"}):n.status(200).json({message:"Bill Deleted Successfully"})})}),module.exports=router;
//# sourceMappingURL=bill.min.js.map
