"use strict";var express=require("express"),connection=require("../connection"),router=express.Router(),jwt=require("jsonwebtoken"),nodemailer=require("nodemailer");require("dotenv").config();var auth=require("../services/authentication"),checkRole=require("../services/checkRole");router.post("/signup",function(e,t){var r=e.body;query="select email,password,role,status from user where email=?",connection.query(query,[r.email],function(e,s){return e?t.status(500).json(e):s.length<=0?(query="insert into user(name,contactNumber,email,password,status,role) values(?,?,?,?,'false','user')",void connection.query(query,[r.name,r.contactNumber,r.email,r.password],function(e,s){return e?t.status(500).json(e):t.status(200).json({message:"Successfully Registered"})})):t.status(400).json({message:"Email Already Exist."})})}),router.post("/login",function(e,o){var n=e.body;query="select email,password,role,status from user where email=?",connection.query(query,[n.email],function(e,s){if(e)return o.status(500).json(e);if(s.length<=0||s[0].password!=n.password)return o.status(401).json({message:"Incorrect Username and password"});if("false"===s[0].status)return o.status(401).json({message:"Wait for admin Approval"});if(s[0].password!=n.password)return o.status(400).json({message:"something went wrong.Please try again later"});var t={email:s[0].email,role:s[0].role},r=jwt.sign(t,process.env.ACCESS_TOKEN,{expiresIn:"8h"});o.status(200).json({token:r})})});var transporter=nodemailer.createTransport({service:"gmail",auth:{user:process.env.EMAIL,pass:process.env.PASSWORD}});router.post("/forgotpassword",function(e,r){var s=e.body;query="select email,password from user where email=?",connection.query(query,[s.email],function(e,s){if(e)return r.status(500).json(e);if(s.length<=0)return r.status(200).json({message:"Password sent successfully to your email."});var t={from:process.env.EMAIL,to:s[0].email,subject:"Password by Cafe mangement System",html:"<p><b>Login details for Cafe Management System</b><br><b>Email: </b>"+s[0].email+"<br><b>Password: </b>"+s[0].password+'<br><a href="http://localhost:4200/">Click  here to login</a></p>'};return transporter.sendMail(t,function(e,s){e?console.log(e):console.log("Email sent:"+s.response)}),r.status(200).json({message:"Password sent successfully to your email."})})}),router.get("/get",auth.authenticateToken,checkRole.checkRole,function(e,t){connection.query("select id,name,email,contactNumber,status from user where role='user'",function(e,s){return e?t.status(500).json(e):t.status(200).json(s)})}),router.patch("/update",auth.authenticateToken,checkRole.checkRole,function(e,t){var s=e.body;connection.query("update user  set status=? where id=?",[s.status,s.id],function(e,s){return e?t.status(500).json(e):0==s.affectedRows?t.status(404).json({message:"User id does not exist"}):t.status(200).json({message:"User updated successfully"})})}),router.get("/checkToken",auth.authenticateToken,function(e,s){return s.status(200).json({message:"true"})}),router.post("/changePassword",auth.authenticateToken,function(e,t){var r=e.body,o=t.locals.email;console.log(o);var n="select * from user where email=? and password=?";connection.query(n,[o,r.oldPassword],function(e,s){return e?t.status(500).json(e):s.length<=0?t.status(400).json({message:"Incorrect Old Password"}):s[0].password!=r.oldPassword?t.status(400).json({message:"Something went wrong.Please try later"}):(n="update user set password=? where email=?",void connection.query(n,[r.newPassword,o],function(e,s){return e?t.status(500).json(e):t.status(200).json({message:"Password Updated Successfully"})}))})}),module.exports=router;
//# sourceMappingURL=user.min.js.map
